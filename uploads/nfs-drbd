#cloud-config
#!/bin/bash 

### Data Disk configuration (/dev/vdb can change)
sudo fdisk -u -p /dev/vdb <<EOF
n
p



w
EOF

### Install packages  
sudo apt-get update
sudo apt-get install drbd-utils && nfs-kernel-server && heartbeat
echo "y"

### Enable DRBD
sudo modprobe drbd

sudo tee -a drbd0.res > /etc/drbd.d <<EOT
resource r0 {

startup {
              wfc-timeout 30;
              degr-wfc-timeout 15;
    }

disk {
    on-io-error   detach;
}
syncer {
rate 320M;
}

    on ecs-nfs-maitre {
            device /dev/drbd0;
            disk /dev/vdb;
            address 192.168.0.50:7788;
            meta-disk internal;
    }
    on ecs-nfs-esclave {
            device /dev/drbd0;
            disk /dev/vdb;
            address 192.168.0.51:7788;
            meta-disk internal;
    }
}
EOT

### enable DRBD configuration
sudo drbdadm create-md r0
sudo drbdadm up r0

### Heartbeat configuration 

sudo tee -a ha.cf >/etc/ha.d <<EOT
mcast eth0 239.0.0.10 694 1 0
 
warntime 4
deadtime 5
initdead 15
keepalive 2
 
#Auto failback when master node goes online again
auto_failback on
 
#Name of clusters node
node ecs-nfs-maitre
node ecs-nfs-slave
EOT

### Authkey creation (generate a password)
sudo tee -a authkey >/etc/ha.d <<EOT
auth 3
3 md5 Pa$$word_of_your_choice
EOT

sudo chmod 600 /etc/ha.d/authkey

### Sleep for 10m only for ECS Master, mark as comment for the slave
read -r -p "Wait 5 Minutes or press any key to continue immediately" -t 5m -n 1 -s

### DRBD start for master instance
drbdadm -- --overwrite-data-of-peer primary r0

### DRBD start for slave instance
#drbdadm secondary r0

### waiting for ending of initial sync
read -r -p "Wait 10 Minutes or press any key to continue immediately" -t 10m -n 1 -s

### Only on the master node
sudo mkfs.ext4 /dev/drbd0

### Create the data folder and configure nfs folder
sudo mkdir /data-nfs

echo "/datas-nfs 0.0.0.0/0(rw,sync,fsid=0,no_root_squash,no_subtree_check)" >> /etc/exports

### heartbeat VIP and mounting point (don't forget to create VIP in FE also
echo "ecs-nfs-maitre IPaddr::10.1.0.30/24/eth0 drbddisk::r0 Filesystem::/dev/drbd0::/data-nfs::ext4 nfs-kernel-server" >> /etc/ha.d/haresources

### disable auto launch of NFS 
sudo insserv -r nfs-kernel-server

###Start Heartbeat
sudo /etc/init.d/heatbeat start

